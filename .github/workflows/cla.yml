name: "CLA Debugger"
on:
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  Debug-Connectivity:
    runs-on: ubuntu-latest
    steps:
      - name: "Test Token Connectivity"
        env:
          # Import the secret to test
          TEST_TOKEN: ${{ secrets.CLA_PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "=== DEBUG START ==="
          
          # 1. Check if Secret exists (Is it empty?)
          if [ -z "$TEST_TOKEN" ]; then
            echo "❌ CRITICAL: The Secret 'CLA_PERSONAL_ACCESS_TOKEN' is EMPTY."
            echo "   This means the workflow cannot see the secret."
            echo "   Fix: Ensure it is a 'Repository Secret' and not an 'Environment Secret'."
            exit 1
          else
            echo "✅ Secret is present (Length: ${#TEST_TOKEN} chars)"
          fi

          # 2. Try to access the private repo manually
          echo "Attempting to access 'forem/CLA-signatures'..."
          
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $TEST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/forem/CLA-signatures/contents/signatures/version1/cla.json)

          echo "HTTP Status Code: $STATUS"

          if [ "$STATUS" == "200" ]; then
            echo "✅ SUCCESS: The Token works perfectly."
            echo "   If this passes, the issue is inside the CLA Action configuration."
          elif [ "$STATUS" == "404" ]; then
            echo "❌ FAILURE (404): The Token exists but was REJECTED."
            echo "   This means the Token is invalid, expired, or lacks 'repo' scope."
          else
            echo "⚠️ UNEXPECTED: Status $STATUS"
          fi
          echo "=== DEBUG END ==="