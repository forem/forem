jobs:
  CLAAssistant:
    runs-on: ubuntu-latest
    steps:
      # --- NEW DEBUG STEP START ---
      - name: "Debug CLA Configuration"
        env:
          # We map the secret to an ENV var to test it safely
          TEST_PAT: ${{ secrets.CLA_PERSONAL_ACCESS_TOKEN }} 
          TARGET_REPO: ${{ secrets.CLA_REPOSITORY }}
        run: |
          echo "--- Configuration Check ---"
          echo "Target Repository: '$TARGET_REPO'"
          
          # 1. Check if the Token is actually present (Length Check)
          if [ -z "$TEST_PAT" ]; then
            echo "❌ CRITICAL ERROR: CLA_PERSONAL_ACCESS_TOKEN is empty or null."
            exit 1
          else
            echo "✅ Token is present (Length: ${#TEST_PAT} characters)"
          fi

          # 2. Manual Connectivity Test (The "Smoking Gun")
          # We try to reach the repo API using curl. If this returns 404, the token is definitely the problem.
          echo "--- Testing API Connection to $TARGET_REPO ---"
          STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" -H "Authorization: token $TEST_PAT" https://api.github.com/repos/$TARGET_REPO)
          
          if [ "$STATUS_CODE" == "200" ]; then
            echo "✅ API Connection Successful! The token works and can see the repo."
          else
            echo "❌ API Connection FAILED with Status Code: $STATUS_CODE"
            echo "   (If this is 404, your Token does not have permission to see 'forem/CLA-signatures')"
          fi
      # --- NEW DEBUG STEP END ---

      - name: "CLA Assistant"
        if: ((github.event.comment.body == 'recheck' || github.event.comment.body == 'I have read the CLA Document and I hereby sign the CLA') || github.event_name == 'pull_request_target') && github.repository_owner == 'forem'
        uses: contributor-assistant/github-action@v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERSONAL_ACCESS_TOKEN: ${{ secrets.CLA_PERSONAL_ACCESS_TOKEN }}
        with:
          path-to-signatures: 'signatures/version1/cla.json'
          path-to-document: 'https://github.com/forem/forem/blob/main/CLA.md'
          branch: 'main' 
          allowlist: ${{ secrets.CLA_ALLOWLIST }}
          remote-repository-name: ${{ secrets.CLA_REPOSITORY }}
          lock-pullrequest-aftermerge: false