<% title "Edit #{@subforem.domain}" %>

<main id="main-content">
  <header class="crayons-page-header crayons-layout crayons-layout--full">
    <h1 class="crayons-title">Manage <%= @subforem.domain %></h1>
    <div class="flex gap-2">
      <%= link_to "Back to Subforems", subforems_path, class: "crayons-btn crayons-btn--ghost" %>
    </div>
  </header>
  <div class="crayons-layout grid l:grid-cols-2 gap-6 mb-4">

    <!-- LEFT COLUMN: Main content (Form) -->
    <div class="crayons-layout__content">
      <%= form_for @subforem, html: { multipart: true } do |form| %>
        
        <!-- SECTION 1: Basic Information (Admin only) -->
        <% if current_user.any_admin? %>
          <div class="crayons-card p-4 m:p-6 mb-4">
            <h2 class="crayons-subtitle-2 mb-4">Basic Information</h2>
            <div class="flex flex-col gap-4">
              <div class="crayons-field">
                <%= form.label :domain, class: "crayons-field__label" %>
                <%= form.text_field :domain, class: "crayons-textfield" %>
              </div>

              <div class="crayons-field">
                <%= label_tag :community_name, "Community Name", class: "crayons-field__label" %>
                <%= text_field_tag :community_name,
                  Settings::Community.community_name(subforem_id: @subforem.id),
                  class: "crayons-textfield",
                  placeholder: "Enter the community name" %>
                <p class="crayons-field__description">The name of your community as it appears throughout the site.</p>
              </div>
            </div>
          </div>
        <% end %>

        <!-- SECTION 1.5: Discoverability (Admin only) -->
        <% if current_user.any_admin? %>
          <div class="crayons-card p-4 m:p-6 mb-4">
            <h2 class="crayons-subtitle-2 mb-4">Discoverability</h2>
            <div class="flex flex-col gap-4">
              <div class="crayons-field">
                <%= form.label :discoverable, "Discoverable in Directory", class: "crayons-field__label" %>
                <%= form.check_box :discoverable, class: "crayons-checkbox" %>
                <p class="crayons-field__description">Allow this community to appear in the subforems directory.</p>
              </div>
            </div>
          </div>
        <% end %>

        <!-- SECTION 2: Community Settings -->
        <div class="crayons-card p-4 m:p-6 mb-4">
          <h2 class="crayons-subtitle-2 mb-4">Community Settings</h2>
          <div class="flex flex-col gap-4">
            <div class="crayons-field">
              <%= label_tag :community_description, "Community Description", class: "crayons-field__label" %>
              <%= text_area_tag :community_description,
                Settings::Community.community_description(subforem_id: @subforem.id),
                class: "crayons-textfield", rows: 4,
                placeholder: "Describe your community..." %>
              <p class="crayons-field__description">A brief description of what your community is about.</p>
            </div>

            <div class="crayons-field">
              <%= label_tag :tagline, "Tagline", class: "crayons-field__label" %>
              <%= text_field_tag :tagline,
                Settings::Community.tagline(subforem_id: @subforem.id),
                class: "crayons-textfield",
                placeholder: "A short tagline for your community..." %>
              <p class="crayons-field__description">A catchy one-liner that summarizes your community.</p>
            </div>

            <div class="crayons-field">
              <%= label_tag :member_label, "Member Label", class: "crayons-field__label" %>
              <%= text_field_tag :member_label,
                Settings::Community.member_label(subforem_id: @subforem.id),
                class: "crayons-textfield",
                placeholder: "user" %>
              <p class="crayons-field__description">What you call your community members (e.g., "user", "member", "developer").</p>
            </div>
          </div>
        </div>

        <!-- SECTION 3: Feed & Content Settings -->
        <div class="crayons-card p-4 m:p-6 mb-4">
          <h2 class="crayons-subtitle-2 mb-4">Feed & Content Settings</h2>
          <div class="flex flex-col gap-4">
            <div class="crayons-field">
              <%= label_tag :feed_style, "Feed Style", class: "crayons-field__label" %>
              <%= select_tag :feed_style,
                options_for_select(
                  [["Basic", "basic"], ["Rich (with cover images)", "rich"], ["Compact", "compact"]],
                  Settings::UserExperience.feed_style(subforem_id: @subforem.id)
                ),
                class: "crayons-select" %>
              <p class="crayons-field__description">Choose how articles appear in the feed.</p>
            </div>

            <div class="crayons-field">
              <%= label_tag :feed_lookback_days, "Feed Lookback Days", class: "crayons-field__label" %>
              <%= number_field_tag :feed_lookback_days,
                Settings::UserExperience.feed_lookback_days(subforem_id: @subforem.id),
                class: "crayons-textfield",
                min: 1,
                max: 365,
                placeholder: "10" %>
              <p class="crayons-field__description">Number of days to look back when fetching feed content (1-365).</p>
            </div>

            <div class="crayons-field">
              <%= label_tag :internal_content_description_spec, "Internal Content Description Spec", class: "crayons-field__label" %>
              <%= text_area_tag :internal_content_description_spec,
                Settings::RateLimit.internal_content_description_spec(subforem_id: @subforem.id),
                class: "crayons-textfield", rows: 4,
                placeholder: "Describe the internal content description specification..." %>
              <p class="crayons-field__description">Guidelines for AI-generated content descriptions.</p>
            </div>

            <div class="crayons-field">
              <%= label_tag :sidebar_tags, "Sidebar Tags", class: "crayons-field__label" %>
              <%= text_field_tag :sidebar_tags,
                Settings::General.sidebar_tags(subforem_id: @subforem.id).join(","),
                class: "crayons-textfield",
                placeholder: "help,discuss,explainlikeimfive,meta",
                pattern: "[a-z0-9,]+" %>
              <p class="crayons-field__description">Comma-separated list of tags to display in the homepage sidebar (lowercase, no spaces).</p>
            </div>
          </div>
        </div>

        <!-- SECTION 4: Branding -->
        <div class="crayons-card p-4 m:p-6 mb-4">
          <h2 class="crayons-subtitle-2 mb-4">Branding</h2>
          <div class="flex flex-col gap-4">
            <div class="crayons-field">
              <%= label_tag :primary_brand_color_hex, "Primary Brand Color", class: "crayons-field__label" %>
              <div class="flex items-center gap-2">
                <%= text_field_tag :primary_brand_color_hex,
                  Settings::UserExperience.primary_brand_color_hex(subforem_id: @subforem.id),
                  class: "crayons-textfield",
                  placeholder: "#3b49df",
                  pattern: "#[a-fA-F0-9]{6}|#[a-fA-F0-9]{3}" %>
                <input type="color" 
                       value="<%= Settings::UserExperience.primary_brand_color_hex(subforem_id: @subforem.id) %>"
                       onchange="document.getElementById('primary_brand_color_hex').value = this.value"
                       class="h-10 w-10 rounded cursor-pointer">
              </div>
              <p class="crayons-field__description">The main color for your community's branding (hex format).</p>
            </div>

            <% if current_user.any_admin? || current_user.super_moderator? %>
              <div class="crayons-field" data-controller="subforem-image-upload">
                <%= form.label :main_logo, "Main Square Logo", class: "crayons-field__label" %>
                <p class="crayons-field__description">Upload a square logo (128x128px) for main branding. PNG or JPEG, max 8MB.</p>
                <div class="flex flex-1 gap-4">
                  <%= form.file_field :main_logo, 
                      accept: "image/png,image/jpg,image/jpeg,.png,.jpg,.jpeg", 
                      data: { 
                        "max-file-size-mb": "8",
                        action: "change->subforem-image-upload#previewImage",
                        "image-type": "main_logo"
                      } %>
                  <div data-subforem-image-upload-target="preview" class="w-25 h-25" style="width: 100px">
                    <% if Settings::General.logo_png(subforem_id: @subforem.id).present? %>
                      <img src="<%= Settings::General.logo_png(subforem_id: @subforem.id) %>" 
                           alt="Main logo preview" 
                           style="width: 100px"
                           class="object-cover rounded">
                    <% end %>
                  </div>
                </div>
              </div>
              
              <div class="crayons-field" data-controller="subforem-image-upload">
                <%= form.label :nav_logo, "Navigation Bar Logo", class: "crayons-field__label" %>
                <p class="crayons-field__description">Upload a smaller logo (80x80px) for navigation bars. PNG or JPEG, max 8MB.</p>
                <div class="flex flex-1 gap-4">
                  <%= form.file_field :nav_logo, 
                      accept: "image/png,image/jpg,image/jpeg,.png,.jpg,.jpeg", 
                      data: { 
                        "max-file-size-mb": "8",
                        action: "change->subforem-image-upload#previewImage",
                        "image-type": "nav_logo"
                      } %>
                  <div data-subforem-image-upload-target="preview" class="w-25 h-25" style="width: 100px">
                    <% if Settings::General.resized_logo(subforem_id: @subforem.id).present? %>
                      <img src="<%= Settings::General.resized_logo(subforem_id: @subforem.id) %>" 
                           alt="Nav logo preview" 
                           style="width: 100px"
                           class="object-cover rounded">
                    <% end %>
                  </div>
                </div>
              </div>
              
              <div class="crayons-field" data-controller="subforem-image-upload">
                <%= form.label :social_card, "Social Card Image", class: "crayons-field__label" %>
                <p class="crayons-field__description">Upload a social media card image (1200x630px) for sharing. PNG or JPEG, max 8MB.</p>
                <div class="flex flex-1 gap-4">
                  <%= form.file_field :social_card, 
                      accept: "image/png,image/jpg,image/jpeg,.png,.jpg,.jpeg", 
                      data: { 
                        "max-file-size-mb": "8",
                        action: "change->subforem-image-upload#previewImage",
                        "image-type": "social_card"
                      } %>
                  <div data-subforem-image-upload-target="preview" class="w-25" style="width: 100px">
                    <% if Settings::General.main_social_image(subforem_id: @subforem.id).present? %>
                      <img src="<%= Settings::General.main_social_image(subforem_id: @subforem.id) %>" 
                           alt="Social card preview" 
                           style="width: 100px"
                           class="object-cover rounded">
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="mt-6 mb-4">
          <%= form.submit "Update Subforem", class: "crayons-btn crayons-btn--primary" %>
        </div>
      <% end %>
    </div>

    <!-- RIGHT COLUMN: Sidebar (Tags) -->
    <div class="crayons-layout__sidebar-right">
      <div class="crayons-card p-4 m:p-6">
        <h2 class="crayons-subtitle-2 mb-4">Supported Tags</h2>

        <% if @supported_tags.any? %>
          <div class="space-y-2 mb-6" style="max-height: 550px; overflow-y: auto;">
            <% @supported_tags.each do |tag| %>
              <div class="flex items-center justify-between p-2 bg-base-5 rounded-lg" data-supported-tag-id="<%= tag.id %>">
                <div class="flex items-center gap-2">
                  <a href="/t/<%= tag.name %>" class="crayons-tag crayons-tag--monochrome"><%= tag.name %></a>
                  <span class="text-xs color-base-60"><%= tag.taggings_count %> posts</span>
                </div>
                <button class="crayons-btn crayons-btn--s crayons-btn--danger remove-tag-btn" 
                        data-tag-id="<%= tag.id %>" 
                        data-tag-name="<%= tag.name %>">
                  Remove
                </button>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm color-base-60 mb-6">No tags supported yet.</p>
        <% end %>

        <h2 class="crayons-subtitle-2 mb-4">Top Unsupported Tags</h2>

                 <% if @unsupported_tags.any? %>
           <div class="space-y-2" style="max-height: 550px; overflow-y: auto;">
             <% @unsupported_tags.each do |tag| %>
               <div class="flex items-center justify-between p-2 bg-base-5 rounded-lg" data-tag-id="<%= tag.id %>">
                 <a href="/t/<%= tag.name %>" class="crayons-tag crayons-tag--monochrome"><%= tag.name %></a>
                 <div class="flex items-center gap-2">
                   <span class="text-xs color-base-60"><%= tag.taggings_count %> posts</span>
                   <button class="crayons-btn crayons-btn--s crayons-btn--primary add-tag-btn" 
                           data-tag-id="<%= tag.id %>" 
                           data-tag-name="<%= tag.name %>">
                     Add
                   </button>
                 </div>
               </div>
             <% end %>
           </div>
        <% else %>
          <p class="text-sm color-base-60">No unsupported tags found.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- PAGES SECTION -->
  <div class="crayons-layout crayons-card p-4 m:p-6 mb-4">
    <h2 class="crayons-subtitle-2 mb-4">Dedicated Pages</h2>
    
    <% if @pages.any? %>
      <div class="space-y-3">
        <% @pages.each do |page| %>
          <div class="flex items-center justify-between p-3 bg-base-5 rounded-lg">
            <div class="flex-1">
              <div class="font-medium"><%= page.title %></div>
              <div class="text-sm color-base-60"><%= page.description %></div>
              <div class="text-xs color-base-50">
                Slug: <%= page.slug %> | 
                Path: <%= page.is_top_level_path ? "/#{page.slug}" : "/page/#{page.slug}" %>
              </div>
            </div>
            <div class="text-xs color-base-60">
              <%= page.created_at.strftime("%b %d, %Y") %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm color-base-60">No dedicated pages found for this subforem (edit functionality coming soon).</p>
    <% end %>
  </div>

  <!-- NAVIGATION LINKS SECTION -->
  <div class="crayons-layout crayons-card p-4 m:p-6 mb-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="crayons-subtitle-2">Navigation Links</h2>
      <button class="crayons-btn crayons-btn--s crayons-btn--primary" onclick="toggleNavLinkForm()">Add Navigation Link</button>
    </div>
    
    <!-- Add Navigation Link Form -->
    <div id="nav-link-form" class="mb-4 p-4 bg-base-5 rounded-lg" style="display: none;">
      <%= form_with url: create_navigation_link_subforem_path(@subforem), method: :post, local: true do |form| %>
        <div class="grid gap-4">
          <div class="crayons-field">
            <%= label_tag 'navigation_link[name]', "Name", class: "crayons-field__label" %>
            <%= text_field_tag 'navigation_link[name]', nil, class: "crayons-textfield", placeholder: "Reading List", required: true %>
          </div>

          <div class="crayons-field">
            <%= label_tag 'navigation_link[url]', "URL", class: "crayons-field__label" %>
            <%= text_field_tag 'navigation_link[url]', nil, class: "crayons-textfield", placeholder: "/readinglist", required: true %>
          </div>

          <div class="crayons-field">
            <%= label_tag 'navigation_link[icon]', "Icon SVG", class: "crayons-field__label" %>
            <%= text_area_tag 'navigation_link[icon]', nil, class: "crayons-textfield", rows: 3, placeholder: '<svg ...>', required: true %>
            <p class="crayons-field__description">Paste the full SVG code for the icon.</p>
          </div>

          <div class="grid grid-cols-3 gap-4">
            <div class="crayons-field">
              <%= label_tag 'navigation_link[section]', "Section", class: "crayons-field__label" %>
              <%= select_tag 'navigation_link[section]', 
                  options_for_select([["Default", "default"], ["Other", "other"]], "default"),
                  class: "crayons-select" %>
            </div>

            <div class="crayons-field">
              <%= label_tag 'navigation_link[display_to]', "Display To", class: "crayons-field__label" %>
              <%= select_tag 'navigation_link[display_to]', 
                  options_for_select([["All", "all"], ["Logged In", "logged_in"], ["Logged Out", "logged_out"]], "all"),
                  class: "crayons-select" %>
            </div>

            <div class="crayons-field">
              <%= label_tag 'navigation_link[position]', "Position", class: "crayons-field__label" %>
              <%= number_field_tag 'navigation_link[position]', 0, class: "crayons-textfield", min: 0 %>
            </div>
          </div>

          <div class="flex gap-2">
            <%= submit_tag "Create Link", class: "crayons-btn crayons-btn--primary" %>
            <button type="button" class="crayons-btn crayons-btn--ghost" onclick="toggleNavLinkForm()">Cancel</button>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Edit Navigation Link Forms (Hidden by default) -->
    <% @navigation_links.each do |link| %>
      <div id="edit-nav-link-form-<%= link.id %>" class="mb-4 p-4 bg-base-5 rounded-lg" style="display: none;">
        <%= form_with url: update_navigation_link_subforem_path(@subforem, navigation_link_id: link.id), method: :patch, local: true do |form| %>
          <div class="grid gap-4">
            <div class="crayons-field">
              <%= label_tag 'navigation_link[name]', "Name", class: "crayons-field__label" %>
              <%= text_field_tag 'navigation_link[name]', link.name, class: "crayons-textfield", required: true %>
            </div>

            <div class="crayons-field">
              <%= label_tag 'navigation_link[url]', "URL", class: "crayons-field__label" %>
              <%= text_field_tag 'navigation_link[url]', link.url, class: "crayons-textfield", required: true %>
            </div>

            <div class="crayons-field">
              <%= label_tag 'navigation_link[icon]', "Icon SVG", class: "crayons-field__label" %>
              <%= text_area_tag 'navigation_link[icon]', link.icon, class: "crayons-textfield", rows: 3, required: true %>
            </div>

            <div class="grid grid-cols-3 gap-4">
              <div class="crayons-field">
                <%= label_tag 'navigation_link[section]', "Section", class: "crayons-field__label" %>
                <%= select_tag 'navigation_link[section]', 
                    options_for_select([["Default", "default"], ["Other", "other"]], link.section),
                    class: "crayons-select" %>
              </div>

              <div class="crayons-field">
                <%= label_tag 'navigation_link[display_to]', "Display To", class: "crayons-field__label" %>
                <%= select_tag 'navigation_link[display_to]', 
                    options_for_select([["All", "all"], ["Logged In", "logged_in"], ["Logged Out", "logged_out"]], link.display_to),
                    class: "crayons-select" %>
              </div>

              <div class="crayons-field">
                <%= label_tag 'navigation_link[position]', "Position", class: "crayons-field__label" %>
                <%= number_field_tag 'navigation_link[position]', link.position, class: "crayons-textfield", min: 0 %>
              </div>
            </div>

            <div class="flex gap-2">
              <%= submit_tag "Update Link", class: "crayons-btn crayons-btn--primary" %>
              <button type="button" class="crayons-btn crayons-btn--ghost" onclick="toggleEditNavLinkForm(<%= link.id %>)">Cancel</button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    
    <% if @navigation_links.any? %>
      <div class="space-y-3">
        <% @navigation_links.each do |link| %>
          <div class="flex items-center justify-between p-3 bg-base-5 rounded-lg" id="nav-link-<%= link.id %>">
            <div class="flex-1">
              <div class="font-medium flex items-center gap-2">
                <span class="text-sm" style="width: 16px; height: 16px;"><%= link.icon.html_safe %></span>
                <%= link.name %>
              </div>
              <div class="text-sm color-base-60">
                <a href="<%= link.url %>" target="_blank" class="c-link c-link--branded"><%= link.url %></a>
              </div>
              <div class="text-xs color-base-50">
                Section: <%= link.section %> | 
                Display: <%= link.display_to %> | 
                Position: <%= link.position %>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="crayons-btn crayons-btn--s crayons-btn--secondary" onclick="toggleEditNavLinkForm(<%= link.id %>)">Edit</button>
              <%= button_to "Delete", 
                  destroy_navigation_link_subforem_path(@subforem, navigation_link_id: link.id), 
                  method: :delete, 
                  data: { confirm: "Are you sure you want to delete this navigation link?" },
                  class: "crayons-btn crayons-btn--s crayons-btn--danger" %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm color-base-60">No navigation links found for this subforem. Click "Add Navigation Link" to create one.</p>
    <% end %>
  </div>

  <!-- COMMUNITY BOTS SECTION -->
  <div class="crayons-layout crayons-card p-4 m:p-6 mb-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="crayons-subtitle-2">Community Bots</h2>
      <% if current_user.any_admin? || current_user.super_moderator? || current_user.subforem_moderator?(subforem: @subforem) %>
        <%= link_to "Manage Bots", admin_subforem_community_bots_path(@subforem), class: "crayons-btn crayons-btn--s" %>
      <% end %>
    </div>
    
    <% community_bots = User.community_bots_for_subforem(@subforem.id).includes(:api_secrets).order(created_at: :desc) %>
    
    <% if community_bots.any? %>
      <div class="space-y-3">
        <% community_bots.each do |bot| %>
          <div class="flex items-center justify-between p-3 bg-base-5 rounded-lg">
            <div class="flex-1">
              <div class="font-medium flex items-center gap-2">
                <span class="text-lg">ðŸ¤–</span>
                <%= bot.name %>
                <span class="text-sm color-base-60">@<%= bot.username %></span>
              </div>
              <div class="text-sm color-base-60">
                <%= bot.email %>
              </div>
              <div class="text-xs color-base-50">
                Created: <%= bot.created_at.strftime("%b %d, %Y") %> | 
                API Secrets: <%= bot.api_secrets.count %>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <% if current_user.any_admin? || current_user.super_moderator? || current_user.subforem_moderator?(subforem: @subforem) %>
                <%= link_to "View", admin_subforem_community_bot_path(@subforem, bot), class: "crayons-btn crayons-btn--s crayons-btn--secondary" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm color-base-60">No community bots found for this subforem.</p>
    <% end %>
  </div>
</main>

<script>
// Toggle navigation link form
function toggleNavLinkForm() {
  const form = document.getElementById('nav-link-form');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// Toggle edit navigation link form
function toggleEditNavLinkForm(linkId) {
  const form = document.getElementById(`edit-nav-link-form-${linkId}`);
  const navLink = document.getElementById(`nav-link-${linkId}`);
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    navLink.style.display = 'none';
  } else {
    form.style.display = 'none';
    navLink.style.display = 'flex';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const addTagButtons = document.querySelectorAll('.add-tag-btn');
  const removeTagButtons = document.querySelectorAll('.remove-tag-btn');
  
  // Sync color picker with text input
  const colorInput = document.getElementById('primary_brand_color_hex');
  const colorPicker = document.querySelector('input[type="color"]');
  
  if (colorInput && colorPicker) {
    colorInput.addEventListener('input', function() {
      if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
        colorPicker.value = this.value;
      }
    });
  }
  
  // Add tag functionality
  addTagButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const tagId = this.dataset.tagId;
      const tagName = this.dataset.tagName;
      const button = this;
      
      // Disable button and show loading state
      button.disabled = true;
      button.textContent = 'Adding...';
      
      // Make AJAX request
      fetch(`/subforems/<%= @subforem.id %>/add_tag`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ tag_id: tagId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Move the tag from unsupported to supported section
          const tagElement = button.closest('[data-tag-id]');
          const supportedSection = document.querySelector('.space-y-2.mb-6');
          
          if (supportedSection) {
            // Create new supported tag element
            const newSupportedTag = document.createElement('div');
            newSupportedTag.className = 'flex items-center justify-between p-2 bg-base-5 rounded-lg';
            newSupportedTag.setAttribute('data-supported-tag-id', tagId);
            newSupportedTag.innerHTML = `
              <div class="flex items-center gap-2">
                <a href="/t/${tagName}" class="crayons-tag crayons-tag--monochrome">${tagName}</a>
                <span class="text-xs color-base-60">0 posts</span>
              </div>
              <button class="crayons-btn crayons-btn--s crayons-btn--danger remove-tag-btn" 
                      data-tag-id="${tagId}" 
                      data-tag-name="${tagName}">
                Remove
              </button>
            `;
            
            // Add to supported section
            supportedSection.appendChild(newSupportedTag);
            
            // Attach event listener to new remove button
            const newRemoveBtn = newSupportedTag.querySelector('.remove-tag-btn');
            attachRemoveTagListener(newRemoveBtn);
            
            // Remove from unsupported section
            tagElement.remove();
            
            // Show success message
            showNotification('Tag added successfully!', 'success');
          }
        } else {
          showNotification(data.message || 'Failed to add tag', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while adding the tag', 'error');
      })
      .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.textContent = 'Add';
      });
    });
  });
  
  // Remove tag functionality
  function attachRemoveTagListener(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (!confirm('Are you sure you want to remove this tag from the supported tags?')) {
        return;
      }
      
      const tagId = this.dataset.tagId;
      const tagName = this.dataset.tagName;
      const button = this;
      
      // Disable button and show loading state
      button.disabled = true;
      button.textContent = 'Removing...';
      
      // Make AJAX request
      fetch(`/subforems/<%= @subforem.id %>/remove_tag`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ tag_id: tagId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove the tag element
          const tagElement = button.closest('[data-supported-tag-id]');
          tagElement.remove();
          
          // Show success message
          showNotification('Tag removed successfully!', 'success');
        } else {
          showNotification(data.message || 'Failed to remove tag', 'error');
          // Re-enable button
          button.disabled = false;
          button.textContent = 'Remove';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while removing the tag', 'error');
        // Re-enable button
        button.disabled = false;
        button.textContent = 'Remove';
      });
    });
  }
  
  removeTagButtons.forEach(button => {
    attachRemoveTagListener(button);
  });
  
  function showNotification(message, type) {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `crayons-notice crayons-notice--${type === 'success' ? 'success' : 'error'} fixed top-4 right-4 z-50`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
});
</script>
